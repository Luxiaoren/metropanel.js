var lastMouseX,lastMouseY,Tile=function(){function n(n,t,i,r,u,f,e){this.left=n,this.top=t,this.content=i,this.index=r,this.width=u,this.panelId=f,this.id=f.substr(1)+"_tile"+r,this.customClass=e}return n.prototype.getHtml=function(){var n="<div id='{3}' class='tile {5}' style='position: absolute; left: {0}px; top: {1}px; width: {4}px; -moz-user-select: none; -khtml-user-select: none;  -webkit-user-select: none; user-select: none;'>{2}</div>";return n.replace("{0}",this.left.toString()).replace("{1}",this.top.toString()).replace("{2}",this.content).replace("{3}",this.id).replace("{4}",this.width.toString()).replace("{5}",this.customClass)},n.prototype.beginDrag=function(){this.isBeingDragged=!0,this.supposedX=this.left,this.supposedY=this.top,$("#"+this.id).css("z-index","999999999999")},n.prototype.moveBy=function(n,t){if(this.isBeingDragged){var i=$("#"+this.id);i.animate({left:"+="+n,top:"+="+t},0),this.left+=n,this.top+=t}},n.prototype.moveTo=function(n,t){var i=$("#"+this.id);i.animate({left:n,top:t},400,"easeOutCubic"),this.left=n,this.top=t},n.prototype.supposePosition=function(n,t){this.isBeingDragged&&(this.supposedX=n,this.supposedY=t)},n.prototype.endDrag=function(){$(".temp-placeholder").remove(),this.moveTo(this.supposedX,this.supposedY),$("#"+this.id).css("z-index",""),this.isBeingDragged=!1},n.prototype.compare=function(n){var t=this.isBeingDragged?this.supposedY:this.top,i=this.isBeingDragged?this.supposedX:this.left,r=n.isBeingDragged?n.supposedY:n.top,u=n.isBeingDragged?n.supposedX:n.left;return t<r?-1:t>r?1:i<u?-1:i>u?1:0},n.prototype.isOver=function(n){var t=Math.abs(n.top-this.top),i=Math.abs(n.left-this.left);return t<=100&&i<=170},n}(),MetroPanel=function(){function n(n,t,i){this.maxWidth=n,this.panelId=t,this.maxHeight=i,this.count=0,this.newTileX=10,this.newTileY=60,this.tiles=[]}return n.prototype.addTile=function(n,t,i,r){var f,u,e;return r||(r=""),f=this,this.newTileX+t>this.maxWidth&&(this.newTileX=10,this.newTileY+=160),u=new Tile(this.newTileX,this.newTileY,n,this.count++,t,this.panelId,r),e=u.getHtml(),$(this.panelId).append(e),$("#"+u.id).mousedown(function(n){f.handleTileMouseDown(u,n)}),$("#"+u.id).mouseup(function(n){f.handleTileMouseUp(u,n)}),$("#"+u.id).mousemove(function(n){f.handleTileMouseMove(u,n)}),$("#"+u.id).mouseleave(function(n){f.handleTileMouseLeave(u,n)}),this.tiles.push(u),this.newTileX+=t+i,"#"+u.id},n.prototype.releaseDrags=function(){for(var t,n=0;n<this.tiles.length;n++)if(t=this.tiles[n],t.isBeingDragged){t.endDrag();break}},n.prototype.handleTileMouseLeave=function(n){n.isBeingDragged&&n.endDrag()},n.prototype.handleTileMouseDown=function(n,t){t.preventDefault(),n.beginDrag(),lastMouseX=t.pageX,lastMouseY=t.pageY},n.prototype.handleTileMouseMove=function(t,i){var r=this,f,u,e;i.preventDefault(),t.isBeingDragged&&(f=i.pageX-lastMouseX,u=i.pageY-lastMouseY,t.moveBy(f,u),lastMouseX=i.pageX,lastMouseY=i.pageY,e=document.documentElement.clientHeight-i.pageY-document.body.scrollTop,e<=30&&u>0?document.body.scrollTop+=10:i.pageY-document.body.scrollTop<=30&&u<=0&&(document.body.scrollTop-=10),this.destroyTimeOut(),this.timeout=setTimeout(function(){r.destroyTimeOut(),r.otherGroupIntersection(t)||n.findOversAndSuppose(t,r),r.destroyTimeOut()},20)),t.justChanged=!1},n.findOversAndSuppose=function(n,t){var f=t.tiles.filter(function(t){return n!=t&&t.isOver(n)}).sort(function(t,i){return Math.abs(t.left-n.left)-Math.abs(i.left-n.left)}),r,u;over=f[0],over&&(r=n.width==310?n.left-180:n.left,u=n.width==310?n.top:over.top,n.supposePosition(r,u)),t.orderPanel()},n.prototype.otherGroupIntersection=function(t){var e=this,i=$("#"+t.id),o=i.offset().left,s=panels.filter(function(n){return n!=e&&Math.abs($(n.panelId).offset().left-o)<=300}),r=s[0],u,f;return r?(u=this.tiles.indexOf(t),u!=-1&&this.tiles.splice(u,1),i.unbind("mousedown"),i.unbind("mouseup"),i.unbind("mousemove"),i.unbind("mouseleave"),r.tiles.push(t),f=o-$(r.panelId).offset().left,i.css("left",f+"px"),t.left=Math.abs(f),i.appendTo(r.panelId),e.orderPanel(),t.justChanged=!0,n.findOversAndSuppose(t,r),i.mousedown(function(n){r.handleTileMouseDown(t,n)}),i.mousemove(function(n){r.handleTileMouseMove(t,n)}),i.mouseup(function(n){r.handleTileMouseUp(t,n)}),i.mouseleave(function(n){r.handleTileMouseLeave(t,n)}),!0):!1},n.prototype.orderPanel=function(){var r,u;$(".temp-placeholder").remove();var f=this.tiles.sort(function(n,t){return n.compare(t)}),t=10,i=60,n;for(r=0;r<this.tiles.length;r++)n=f[r],t+n.width>this.maxWidth&&(t=10,i+=160),n.isBeingDragged?(u="<div class='temp-placeholder' style='width: {0}px; left: {1}px; top: {2}px; position: absolute;'></div>".replace("{0}",n.width.toString()).replace("{1}",t).replace("{2}",i),$(this.panelId).append(u),n.supposePosition(t,i)):(n.left!=t||n.top!=i)&&n.moveTo(t,i),t+=n.width+10;this.newTileX=t,this.newTileY=i},n.prototype.destroyTimeOut=function(){clearTimeout(this.timeout)},n.prototype.handleTileMouseUp=function(n,t){t.preventDefault(),this.destroyTimeOut(),n.isBeingDragged&&n.endDrag()},n}()